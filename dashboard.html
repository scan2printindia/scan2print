<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Scan2Print Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f5f7f5;
  margin:0;
  padding:20px;
}

.header{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:22px;
}

.brand{
  display:flex;
  align-items:center;
  gap:14px;
}

.logo{
  width:88px;
}

.sectionTitle{
  font-size:18px;
  font-weight:700;
  margin:24px 0 10px;
}

/* CURRENT FILES */
.currentWrap{
  background:#fff;
  border:2px solid #2563eb;
  border-radius:18px;
  padding:16px;
}

.currentFile{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#f0f7ff;
  padding:14px;
  border-radius:14px;
  margin-bottom:10px;
}

.fileInfo{
  font-weight:600;
}

.fileTime{
  font-size:13px;
  color:#6b7280;
}

.fileActions{
  display:flex;
  align-items:center;
  gap:18px; /* SAFETY GAP */
}

/* BUTTONS */
button{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

.doneBtn{
  background:#fff;
  color:#2563eb;
  border:2px solid #2563eb;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin:30px 0;
}

.stat{
  background:#fff;
  border-radius:18px;
  padding:18px;
  text-align:center;
}

.statLabel{
  font-size:16px;
  font-weight:600;
}

.statValue{
  font-size:36px;
  font-weight:800;
}

/* HISTORY */
.tableWrap{
  background:#fff;
  border-radius:18px;
  overflow:hidden;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:14px;
  border-bottom:1px solid #eee;
  font-size:14px;
  opacity:.7;
}

@media(max-width:800px){
  .stats{
    grid-template-columns:1fr;
  }
}
</style>
</head>

<body>

<audio id="notifySound" preload="auto">
  <source src="ding.mp3" type="audio/mpeg">
</audio>

<div class="header">
  <div class="brand">
    <img src="logo.png" class="logo">
    <div>
      <h2 id="shopTitle"></h2>
      <div>Live document intake</div>
    </div>
  </div>
  <button onclick="load()">Refresh</button>
</div>

<div class="sectionTitle">Current Documents</div>
<div class="currentWrap" id="currentWrap">
  Waiting for upload…
</div>

<div class="stats">
  <div class="stat">
    <div class="statLabel">Jobs Today</div>
    <div class="statValue" id="kToday">0</div>
  </div>
  <div class="stat">
    <div class="statLabel">This Week</div>
    <div class="statValue" id="kWeek">0</div>
  </div>
  <div class="stat">
    <div class="statLabel">This Month</div>
    <div class="statValue" id="kMonth">0</div>
  </div>
</div>

<div class="sectionTitle">Recent Files</div>
<div class="tableWrap">
<table>
<thead>
<tr><th>Time</th><th>File</th><th>Status</th></tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwGyVFj84IlyIyw0kyoNmcSARmDw3IVVGluIawmz69dXEja1tXEszMXH7wDkfn47mmPlQ/exec";
const shop=new URLSearchParams(location.search).get("shop")||"General";
shopTitle.innerText="Shop: "+shop;

let lastActive=0;
let unlocked=false;

document.addEventListener("click",()=>unlocked=true,{once:true});

async function load(){
  const res=await fetch(`${SCRIPT_URL}?shop=${shop}&status=ALL`);
  const d=await res.json();

  kToday.innerText=d.summary.today;
  kWeek.innerText=d.summary.week;
  kMonth.innerText=d.summary.month;

  const active=d.files.filter(f=>f.status==="ACTIVE");
  const done=d.files.filter(f=>f.status==="DELETED");

  if(unlocked && active.length>lastActive && lastActive!==0){
    notifySound.play().catch(()=>{});
  }
  lastActive=active.length;

  currentWrap.innerHTML=active.length
    ? active.map(f=>`
      <div class="currentFile">
        <div>
          <div class="fileInfo">${f.fileName}</div>
          <div class="fileTime">Received ${new Date(f.time).toLocaleTimeString()}</div>
        </div>
        <div class="fileActions">
          <button onclick="window.open('${f.fileUrl}')">Download</button>
          <button class="doneBtn" onclick="done('${f.fileId}')">Done</button>
        </div>
      </div>
    `).join("")
    : "Waiting for upload…";

  history.innerHTML=done.map(f=>`
    <tr>
      <td>${new Date(f.time).toLocaleString()}</td>
      <td>${f.fileName}</td>
      <td>Completed</td>
    </tr>
  `).join("");
}

async function done(id){
  await fetch(`${SCRIPT_URL}?action=done&fileId=${id}`);
  load();
}

load();
setInterval(load,10000);
</script>

</body>
</html>
