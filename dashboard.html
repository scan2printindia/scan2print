<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan2Print – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f6f6f6; padding:20px; margin:0; color: #333; }
    .box { background:#fff; max-width:900px; margin:auto; padding:25px; border-radius:12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .header { text-align:center; margin-bottom:20px; }
    .logo { width: 50%; max-width: 250px; margin: auto; display: block; }
    .summary { display:flex; gap:15px; margin:20px 0; }
    .card { flex:1; background:#f8f9fa; padding:20px; border-radius:8px; text-align:center; border: 1px solid #eee; }
    .card strong { font-size: 26px; color: #2d7ff9; display: block; }
    .filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filters select { padding:10px; border-radius:6px; border:1px solid #ddd; outline: none; background: #fff; cursor: pointer; }
    table { width:100%; border-collapse:collapse; margin-top: 10px; }
    th, td { padding:14px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
    th { background:#f1f3f5; color: #495057; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Status Styles */
    .status-queued { color: #f39c12; font-weight: bold; animation: pulse 1.5s infinite; }
    .btn-open { display: inline-block; padding: 6px 12px; background: #2d7ff9; color: #fff; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .btn-open:hover { background: #1a66d1; }
    .status-error { color: #e74c3c; font-size: 12px; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    @media(max-width:600px){ .summary{flex-direction:column} }
  </style>
</head>
<body>

<div class="box">
  <div class="header">
    <img src="logo.png" class="logo" alt="Scan2Print Logo">
    <p style="color: #666; margin-top: 10px;">Real-time Print Queue</p>
  </div>

  <div class="summary">
    <div class="card"><strong id="today">0</strong>Today</div>
    <div class="card"><strong id="week">0</strong>This Week</div>
    <div class="card"><strong id="month">0</strong>This Month</div>
  </div>

  <div class="filters">
    <select id="statusFilter" onchange="renderTable()">
      <option value="ALL">All Files</option>
      <option value="ACTIVE">Ready to Print</option>
      <option value="PENDING">Queued/Processing</option>
    </select>

    <select id="dateFilter" onchange="renderTable()">
      <option value="TODAY" selected>Today Only</option>
      <option value="WEEK">This Week</option>
      <option value="ALL">All Time</option>
    </select>
  </div>

  <table>
    <thead><tr><th>Time</th><th>File Name</th><th>Action</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
let allFiles = [];
const params = new URLSearchParams(location.search);
const shop = params.get("shop");

// 1. Replace this with your Google Web App URL
const scriptUrl = "https://script.google.com/macros/s/AKfycbwGyVFj84IlyIyw0kyoNmcSARmDw3IVVGluIawmz69dXEja1tXEszMXH7wDkfn47mmPlQ/exec";

function loadDashboardData(){
  if(!shop) return;
  fetch(`${scriptUrl}?shop=${shop}&t=${Date.now()}`)
  .then(r=>r.json())
  .then(data=>{
    document.getElementById("today").innerText = data.summary.today;
    document.getElementById("week").innerText = data.summary.week;
    document.getElementById("month").innerText = data.summary.month;
    allFiles = data.files;
    renderTable();
  }).catch(err => console.log("Data fetch error:", err));
}

function renderTable(){
  const sFilter = document.getElementById("statusFilter").value;
  const dFilter = document.getElementById("dateFilter").value;
  const tbody = document.getElementById("rows");
  const now = new Date();
  
  const startOfWeek = new Date(now);
  startOfWeek.setDate(now.getDate() - now.getDay());
  startOfWeek.setHours(0, 0, 0, 0);

  tbody.innerHTML = "";

  const filtered = allFiles.filter(f => {
    const t = new Date(f.timestamp);
    const matchesStatus = (sFilter === "ALL" || f.status === sFilter);
    
    let matchesDate = false;
    if (dFilter === "ALL") matchesDate = true;
    else if (dFilter === "TODAY") matchesDate = t.toDateString() === now.toDateString();
    else if (dFilter === "WEEK") matchesDate = t >= startOfWeek;

    return matchesStatus && matchesDate;
  });

  if(filtered.length === 0) {
    tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:40px; color:#999;'>No print jobs found.</td></tr>";
    return;
  }

  filtered.forEach(f => {
    let actionHtml = "";
    if(f.status === "ACTIVE") {
      actionHtml = `<a href="${f.fileUrl}" target="_blank" class="btn-open">VIEW & PRINT</a>`;
    } else if (f.status === "PENDING") {
      actionHtml = `<span class="status-queued">⌛ QUEUED...</span>`;
    } else {
      actionHtml = `<span class="status-error">⚠️ System Delay</span>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${new Date(f.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
        <td>${f.fileName}</td>
        <td>${actionHtml}</td>
      </tr>`;
  });
}

// Initial load
loadDashboardData();
// Poll every 10 seconds (optimized for 1,000 users)
setInterval(loadDashboardData, 10000); 
</script>
</body>
</html>
