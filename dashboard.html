<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan2Print Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root { --primary:#2d7ff9; --success:#10b981; --danger:#ef4444; }
    body { font-family:Segoe UI, sans-serif; background:#f4f7f6; margin:0; padding:20px; }
    .container { max-width:1100px; margin:auto; }
    .header { display:flex; justify-content:space-between; align-items:center; background:#fff;
              padding:15px 25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .filter-bar { margin:20px 0; display:flex; gap:10px; justify-content:center; }
    .filter-btn { border:2px solid var(--primary); background:#fff; color:var(--primary);
                  padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:600; }
    .filter-btn.active { background:var(--primary); color:#fff; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-bottom:20px; }
    .stat-card { background:#fff; padding:20px; border-radius:10px; text-align:center;
                 border-top:4px solid var(--primary); box-shadow:0 2px 5px rgba(0,0,0,.05); }
    table { width:100%; background:#fff; border-radius:10px; overflow:hidden;
            border-collapse:collapse; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    th { background:var(--primary); color:#fff; padding:14px; text-align:left; }
    td { padding:14px; border-bottom:1px solid #eee; }
    .btn { padding:6px 12px; border:none; border-radius:4px; color:#fff; cursor:pointer; }
    .btn-view { background:var(--primary); }
    .btn-print { background:var(--success); }
    .btn-done { background:var(--danger); }
    .deleted { color:#888; text-decoration:line-through; }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h2 id="shopTitle">Dashboard</h2>
    <button class="filter-btn" onclick="refresh()">ðŸ”„ Sync</button>
  </div>

  <div class="filter-bar">
    <button class="filter-btn active" onclick="setFilter('today',this)">Today</button>
    <button class="filter-btn" onclick="setFilter('week',this)">7 Days</button>
    <button class="filter-btn" onclick="setFilter('all',this)">All</button>
  </div>

  <div class="grid">
    <div class="stat-card">Today<h1 id="tStat">0</h1></div>
    <div class="stat-card">Weekly<h1 id="wStat">0</h1></div>
    <div class="stat-card">Total<h1 id="totalStat">0</h1></div>
  </div>

  <table>
    <thead>
      <tr><th>Received</th><th>Filename</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="queue"></tbody>
  </table>
</div>

<iframe id="printFrame" style="display:none"></iframe>

<script>
/* ðŸ”´ IMPORTANT: PUT YOUR **LATEST DEPLOYED** /exec URL HERE */
const CONFIG = {
  url: "https://script.google.com/macros/s/AKfycbwGyVFj84IlyIyw0kyoNmcSARmDw3IVVGluIawmz69dXEja1tXEszMXH7wDkfn47mmPlQ/exec",
  shop: new URLSearchParams(location.search).get("shop")
};

let allFiles = [];
let currentFilter = "today";

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  render();
}

async function refresh() {
  if (!CONFIG.shop) return alert("Missing shop parameter");
  document.getElementById("shopTitle").innerText = "Shop: " + CONFIG.shop;

  const res = await fetch(`${CONFIG.url}?shop=${CONFIG.shop}&t=${Date.now()}`);
  const data = await res.json();

  allFiles = data.files;
  tStat.innerText = data.summary.today;
  wStat.innerText = data.summary.week;
  totalStat.innerText = data.summary.total;

  render();
}

function render() {
  const now = new Date();
  let html = "";

  const filtered = allFiles.filter(f => {
    const d = new Date(f.timestamp);
    if (currentFilter === "today") return d.toDateString() === now.toDateString();
    if (currentFilter === "week") return (now - d) < 7*86400000;
    return true;
  });

  filtered.forEach(f => {
    const del = f.status === "DELETED";
    html += `<tr>
      <td>${new Date(f.timestamp).toLocaleString()}</td>
      <td class="${del?'deleted':''}">${f.fileName}</td>
      <td style="color:${del?'red':'green'}">${f.status}</td>
      <td>${del ? "-" : `
        <button class="btn btn-view" onclick="handle('${f.fileId}','open')">View</button>
        <button class="btn btn-print" onclick="handle('${f.fileId}','print')">Print</button>
        <button class="btn btn-done" onclick="markDone('${f.fileId}')">Done</button>`}
      </td>
    </tr>`;
  });

  queue.innerHTML = html || `<tr><td colspan="4" align="center">No files</td></tr>`;
}

function handle(fileId, type) {
  const url = `${CONFIG.url}?action=proxy&fileId=${fileId}`;

  if (type === "open") {
    window.open(url, "_blank");
    return;
  }

  // PRINT
  const iframe = document.getElementById("printFrame");
  iframe.src = url;

  iframe.onload = () => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
  };
}


async function markDone(id) {
  if (!confirm("Mark as completed?")) return;
  await fetch(`${CONFIG.url}?action=delete&fileId=${id}`);
  refresh();
}

refresh();
setInterval(refresh, 20000);
</script>
</body>
</html>

