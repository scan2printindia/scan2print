<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Scan2Print Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f4f7f6;padding:18px;margin:0}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:88px;height:auto}
h2{margin:0;font-size:18px}
.muted{color:#78909c;font-size:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
select,button{padding:8px 10px;border-radius:10px;border:1px solid #cfd8dc;font-size:14px}
button{background:#2d7ff9;color:#fff;border:none;cursor:pointer;font-weight:bold}
button:hover{background:#1a66d1}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0}
.kpi{background:#fff;padding:12px;border-radius:14px;border:1px solid #e6ecef;text-align:center}
.value{font-size:22px;font-weight:800;color:#2d7ff9}
table{width:100%;background:#fff;border-collapse:collapse;border-radius:14px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
th,td{padding:12px;border-bottom:1px solid #eee;font-size:14px}
th{background:#2d7ff9;color:#fff;text-align:left}
.done{color:gray;text-decoration:line-through}
.btn-done{background:#fff;color:#2d7ff9;border:1px solid #2d7ff9;margin-left:5px;padding:8px 10px;border-radius:8px;cursor:pointer}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <img src="logo.png" class="logo" alt="logo">
    <div>
      <h2 id="title"></h2>
      <div class="muted">Manage uploads</div>
    </div>
  </div>
  <div class="controls">
    <select id="period">
      <option value="today">Today</option>
      <option value="week">Week</option>
      <option value="month">Month</option>
      <option value="all">All Time</option>
    </select>
    <select id="status">
      <option value="ACTIVE">Active Only</option>
      <option value="DELETED">Deleted Only</option>
      <option value="ALL">Show All</option>
    </select>
    <button id="applyBtn">Apply & Refresh</button>
  </div>
</div>

<div class="kpis">
  <div class="kpi"><div>Today</div><div class="value" id="kToday">0</div></div>
  <div class="kpi"><div>Week</div><div class="value" id="kWeek">0</div></div>
  <div class="kpi"><div>Month</div><div class="value" id="kMonth">0</div></div>
</div>

<table>
<thead>
  <tr><th>Time</th><th>File</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody id="list"></tbody>
</table>

<script>
/* FINAL dashboard.js */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGyVFj84IlyIyw0kyoNmcSARmDw3IVVGluIawmz69dXEja1tXEszMXH7wDkfn47mmPlQ/exec";
const shop = new URLSearchParams(location.search).get("shop") || "General";
document.getElementById("title").innerText = "Shop: " + shop;

const applyBtn = document.getElementById("applyBtn");
applyBtn.addEventListener("click", load);

async function load(){
  applyBtn.disabled = true;
  const p = document.getElementById("period").value;
  const s = document.getElementById("status").value;

  try {
    const res = await fetch(`${SCRIPT_URL}?shop=${encodeURIComponent(shop)}&period=${encodeURIComponent(p)}&status=${encodeURIComponent(s)}`);
    const d = await res.json();

    kToday.innerText = d.summary.today;
    kWeek.innerText = d.summary.week;
    kMonth.innerText = d.summary.month;

    const listBody = document.getElementById("list");
    if(!Array.isArray(d.files) || d.files.length === 0) {
      listBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:18px;color:#6b7280">No files found for this filter.</td></tr>';
      applyBtn.disabled = false;
      return;
    }

    listBody.innerHTML = d.files.map(f => {
      const isDeleted = (String(f.status || "").trim().toUpperCase() === "DELETED");
      return `
        <tr>
          <td style="white-space:nowrap">${new Date(f.time).toLocaleString()}</td>
          <td class="${isDeleted ? 'done' : ''}">${escapeHtml(f.fileName)}</td>
          <td><strong>${isDeleted ? 'Deleted' : 'Active'}</strong></td>
          <td>
            ${!isDeleted ? `<button onclick="window.open('${encodeURI(f.fileUrl)}')">Download</button>
              <button class="btn-done" onclick="markDone('${escapeJS(f.fileId)}')">Done</button>` : '-'}
          </td>
        </tr>`;
    }).join("");

  } catch(err) {
    document.getElementById("list").innerHTML = `<tr><td colspan="4" style="text-align:center;color:#c00">Error loading files: ${escapeHtml(err.message)}</td></tr>`;
  } finally {
    applyBtn.disabled = false;
  }
}

async function markDone(id){
  if(!confirm("Mark this file as deleted?")) return;
  try {
    await fetch(`${SCRIPT_URL}?action=done&fileId=${encodeURIComponent(id)}`);
    load();
  } catch(e) {
    alert("Failed to mark as deleted.");
  }
}

/* small helpers to avoid accidental injection from sheet text */
function escapeHtml(s){ return String(s || "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeJS(s){ return String(s || "").replace(/['"\\]/g, c => '\\' + c); }

/* initial load */
load();
</script>

</body>
</html>
