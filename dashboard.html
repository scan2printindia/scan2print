<script>
let allFiles = [];
const params = new URLSearchParams(location.search);
const shop = params.get("shop");
const scriptUrl = "PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE";

function loadDashboardData(){
  if(!shop) return;
  fetch(`${scriptUrl}?shop=${shop}&t=${Date.now()}`)
  .then(r=>r.json())
  .then(data=>{
    document.getElementById("today").innerText = data.summary.today;
    document.getElementById("week").innerText = data.summary.week;
    document.getElementById("month").innerText = data.summary.month;
    allFiles = data.files;
    renderTable();
  });
}

function renderTable(){
  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  allFiles.forEach(f => {
    let actionHtml = "";
    // Improved logic for scaling:
    if(f.status === "ACTIVE") {
      actionHtml = `<a href="${f.fileUrl}" target="_blank" class="btn-open">Open File</a>`;
    } else if (f.status === "PENDING") {
      actionHtml = `<span style="color:#f39c12; animation: pulse 1.5s infinite;">âŒ› Queued...</span>`;
    } else {
      actionHtml = `<span style="color:#e74c3c;">Error</span>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${new Date(f.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
        <td>${f.fileName}</td>
        <td>${actionHtml}</td>
      </tr>`;
  });
}

// Optimization: Poll every 10 seconds instead of 3 to save Google Quota
setInterval(loadDashboardData, 10000); 
loadDashboardData();
</script>

<style>
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
