<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan2Print ‚Äì Upload</title>
  <script>UPLOADCARE_PUBLIC_KEY = "391d407e7314b71facae";</script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; padding: 20px; text-align: center; color: #333; }
    .box { background: #fff; max-width: 500px; margin: 40px auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .logo { width: 60%; max-width: 250px; margin-bottom: 20px; }
    .spinner { display: none; width: 40px; height: 40px; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #2d7ff9; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #status { margin: 20px 0; font-size: 16px; line-height: 1.5; }
    #refreshBtn { display: none; margin-top: 20px; padding: 12px 25px; background: #2d7ff9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    #refreshBtn:hover { background: #1a66d1; }
  </style>
</head>
<body>
  <div class="box">
    <img src="logo.png" class="logo" alt="Scan2Print">
    <h3>Upload for Printing</h3>
    <div id="uploadContainer">
      <input type="hidden" role="uploadcare-uploader" data-clearable data-file-types="pdf jpg jpeg png doc docx" id="uploader" />
    </div>
    <div id="loader" class="spinner"></div>
    <div id="status"></div>
    <button id="refreshBtn" onclick="location.reload()">üîÑ Upload Another</button>
  </div>

  <script>
    // 1. Get Shop ID from URL
    const shop = new URLSearchParams(window.location.search).get("shop");
    if (!shop) { 
      document.getElementById("status").innerHTML = "<span style='color:red;'>‚ùå Missing Shop ID. Please scan the QR code again.</span>";
      document.getElementById("uploadContainer").style.display = "none";
    }

    // 2. Replace this with your Google Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGyVFj84IlyIyw0kyoNmcSARmDw3IVVGluIawmz69dXEja1tXEszMXH7wDkfn47mmPlQ/exec";

    const widget = uploadcare.Widget("#uploader");
    
    widget.onUploadComplete(info => {
      document.getElementById("uploadContainer").style.display = "none";
      document.getElementById("loader").style.display = "block";
      document.getElementById("status").innerText = "Connecting to Print Shop...";

      // Sending data to the "Fast Receiver" (Catcher)
      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", // Required for cross-domain Google Apps Script
        body: JSON.stringify({ 
          shop: shop, 
          fileName: info.name, 
          fileUrl: info.cdnUrl 
        })
      }).then(() => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("status").innerHTML = "<b>‚úÖ File Received!</b><br>Our system is preparing it for print.<br>Please visit the counter.";
        document.getElementById("refreshBtn").style.display = "inline-block";
      }).catch(err => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("status").innerHTML = "‚ö†Ô∏è Connection error, but your file was uploaded. Please tell the staff.";
      });
    });
  </script>
</body>
</html>
